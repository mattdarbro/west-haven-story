<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FictionMail Dev Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
        }
        .card h2 { color: #667eea; margin-bottom: 20px; font-size: 1.5rem; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-weight: 500; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 1rem;
        }
        textarea { resize: vertical; min-height: 80px; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #dc3545; }
        .debug-panel {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #222; }
        .story-display {
            background: #f9f9f9;
            color: #1a1a1a;
            padding: 40px;
            border-radius: 12px;
            line-height: 1.8;
        }
        .story-title { font-size: 2rem; margin-bottom: 30px; color: #667eea; text-align: center; }
        .story-text { white-space: pre-wrap; }
        .rating-stars { display: flex; gap: 10px; font-size: 2rem; margin: 20px 0; justify-content: center; }
        .rating-stars span { cursor: pointer; opacity: 0.3; }
        .rating-stars span.active { opacity: 1; }
        .hidden { display: none; }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input { width: auto; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìß FictionMail Dev Dashboard</h1>
            <p class="subtitle">Test story generation flow</p>
            <p class="subtitle" style="font-size: 0.9rem; margin-top: 10px;">
                Backend: <span id="backend-url">Loading...</span>
            </p>
        </header>

        <div id="app">
            <div id="onboarding-section">
                <div class="grid">
                    <div class="card">
                        <h2>Step 1: Create Your Story World</h2>
                        <div class="form-group">
                            <label>Genre</label>
                            <select id="genre">
                                <option value="scifi">üöÄ Sci-Fi</option>
                                <option value="mystery">üîç Mystery</option>
                                <option value="romance">üíï Romance</option>
                                <option value="fantasy">üßô Fantasy</option>
                                <option value="horror">üëª Horror</option>
                                <option value="drama">üé≠ Drama</option>
                                <option value="western">ü§† Western</option>
                                <option value="historical">üìú Historical</option>
                                <option value="sitcom">üòÇ Sitcom (Premium)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Setting (1-2 sentences)</label>
                            <textarea id="setting" placeholder="Space station on the edge of known space"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Character Name (optional)</label>
                            <input type="text" id="characterName" placeholder="Elena">
                        </div>
                        <div class="form-group">
                            <label>Tier</label>
                            <select id="tier">
                                <option value="free">Free (1500 words)</option>
                                <option value="premium">Premium (3000 words)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Email (for testing email delivery)</label>
                            <input type="email" id="userEmail" placeholder="your@email.com">
                            <small style="color: #666; font-size: 12px;">Story will be emailed to this address after generation</small>
                        </div>
                        <div class="form-group">
                            <label>Narrator Voice</label>
                            <select id="voiceId">
                                <option value="EXAVITQu4vr4xnSDxMaL">Default (Sarah - Female)</option>
                                <option value="21m00Tcm4TlvDq8ikWAM">Rachel (Female - Calm)</option>
                                <option value="AZnzlk1XvdvUeBnXmlld">Domi (Female - Strong)</option>
                                <option value="ErXwobaYiN019PkySvjV">Antoni (Male - Well-rounded)</option>
                                <option value="VR6AewLTigWG4xSOukaG">Arnold (Male - Crisp)</option>
                                <option value="pNInz6obpgDQGcFmaJgB">Adam (Male - Deep)</option>
                                <option value="yoZ06aMxZJJ28mfd3POQ">Sam (Male - Raspy)</option>
                                <option value="CwhRBWXzGAHq8TQ4Fs17">Roger (Male - Confident)</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Choose a voice for text-to-speech narration</small>
                        </div>
                        <button onclick="createBible()">‚ú® Enhance Bible</button>
                    </div>
                    <div class="card">
                        <h2>üîß Debug Logs</h2>
                        <div id="logs" class="debug-panel">
                            <div class="log-entry">Ready...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bible-section" class="hidden">
                <div class="grid">
                    <div class="card">
                        <h2>Step 2: Generate Story</h2>
                        <div id="bible-preview" class="debug-panel" style="max-height: 300px; margin-bottom: 20px;"></div>
                        <button id="generateBtn" onclick="generateStory()">üé¨ Generate Story</button>
                        <button onclick="resetAll()" class="btn-danger" style="margin-left: 10px;">üîÑ Reset</button>
                        <div id="generation-status" class="hidden" style="margin-top: 20px; padding: 15px; background: #1a3a52; border: 1px solid #2563eb; border-radius: 6px; text-align: center;">
                            <div class="spinner" style="margin: 0 auto 10px;"></div>
                            <div id="status-text">Generating story...</div>
                        </div>
                    </div>
                    <div class="card">
                        <h2>üîß Generation Progress</h2>
                        <div id="generation-logs" class="debug-panel">
                            <div class="log-entry">Click "Generate Story" to begin...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="story-section" class="hidden">
                <div class="card">
                    <div id="story-content" class="story-display"></div>
                    <h2 style="margin-top: 30px;">Rate This Story</h2>
                    <div class="rating-stars" id="rating-stars">
                        <span data-rating="1">‚≠ê</span>
                        <span data-rating="2">‚≠ê</span>
                        <span data-rating="3">‚≠ê</span>
                        <span data-rating="4">‚≠ê</span>
                        <span data-rating="5">‚≠ê</span>
                    </div>
                    <div id="feedback-section" class="hidden">
                        <div class="checkbox-group" id="feedback-options"></div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="submitRating()" id="submit-rating-btn" class="hidden">Submit Rating</button>
                        <button onclick="generateAnother()" style="margin-left: 10px;">Generate Another</button>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h2>üîç Debug Info</h2>
                    <div id="debug-info" class="debug-panel"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://web-production-5252.up.railway.app';
        document.getElementById('backend-url').textContent = API_URL;

        let currentBible = null;
        let currentStory = null;
        let selectedRating = 0;

        function log(msg) {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        async function createBible() {
            log('Creating bible...');
            const data = {
                genre: document.getElementById('genre').value,
                setting: document.getElementById('setting').value,
                character_name: document.getElementById('characterName').value || null,
                tier: document.getElementById('tier').value
            };

            if (!data.setting.trim()) return alert('Enter a setting');

            try {
                const res = await fetch(`${API_URL}/api/dev/onboarding`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    currentBible = result.bible;
                    log('‚úì Bible enhanced!');
                    document.getElementById('bible-preview').innerHTML = `
                        <strong>Setting:</strong> ${result.bible.setting.name}<br>
                        <strong>Protagonist:</strong> ${result.bible.protagonist.name}<br>
                        <strong>Trait:</strong> ${result.bible.protagonist.defining_characteristic}<br>
                        <details><summary>Full JSON</summary><pre>${JSON.stringify(result.bible, null, 2)}</pre></details>
                    `;
                    document.getElementById('onboarding-section').classList.add('hidden');
                    document.getElementById('bible-section').classList.remove('hidden');
                }
            } catch (e) {
                log('‚úó Error: ' + e.message);
                alert('Error: ' + e.message);
            }
        }

        function generationLog(msg) {
            const logs = document.getElementById('generation-logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        let logPollingInterval = null;

        async function pollGenerationLogs() {
            try {
                const res = await fetch(`${API_URL}/api/dev/logs`);
                const data = await res.json();
                if (data.logs && data.logs.length > 0) {
                    const lastLog = data.logs[data.logs.length - 1];
                    generationLog(lastLog.message);
                }
            } catch (e) {
                // Silently fail polling
            }
        }

        async function generateStory() {
            // Disable button to prevent double-clicks
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            // Clear logs
            document.getElementById('generation-logs').innerHTML = '';

            // Show status
            document.getElementById('generation-status').classList.remove('hidden');
            generationLog('Starting story generation...');

            // Start polling logs every 2 seconds
            logPollingInterval = setInterval(pollGenerationLogs, 2000);

            try {
                const email = document.getElementById('userEmail').value;
                const voiceId = document.getElementById('voiceId').value;

                generationLog('Sending request to server...');

                const res = await fetch(`${API_URL}/api/dev/generate-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bible: currentBible,
                        email: email || null,
                        voice_id: voiceId
                    })
                });

                generationLog('Server responded, processing...');
                const data = await res.json();

                // Stop polling
                clearInterval(logPollingInterval);
                logPollingInterval = null;

                if (data.success) {
                    currentStory = data.story;
                    generationLog(`‚úì Story generated! ${data.story.word_count} words in ${data.debug.generation_time.toFixed(1)}s`);

                    if (data.email_sent) {
                        generationLog(`‚úì Email sent successfully!`);
                    }

                    document.getElementById('story-content').innerHTML = `
                        <div class="story-title">${data.story.title}</div>
                        <div class="story-text">${data.story.narrative}</div>
                    `;
                    document.getElementById('debug-info').innerHTML = `
                        <strong>Words:</strong> ${data.story.word_count}<br>
                        <strong>Time:</strong> ${data.debug.generation_time.toFixed(1)}s<br>
                        <strong>Plot:</strong> ${data.debug.plot_type}<br>
                        <strong>Email Sent:</strong> ${data.email_sent ? 'Yes ‚úì' : 'No'}<br>
                        <details><summary>Beat Plan</summary><pre>${JSON.stringify(data.debug.beat_plan, null, 2)}</pre></details>
                    `;

                    // Hide status and move to story section
                    document.getElementById('generation-status').classList.add('hidden');
                    document.getElementById('bible-section').classList.add('hidden');
                    document.getElementById('story-section').classList.remove('hidden');
                    setupRating();
                } else {
                    generationLog('‚úó Error: ' + (data.error || 'Unknown error'));
                    alert('Generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                // Stop polling
                if (logPollingInterval) {
                    clearInterval(logPollingInterval);
                    logPollingInterval = null;
                }

                generationLog('‚úó Error: ' + e.message);
                alert('Error: ' + e.message);
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'üé¨ Generate Story';
                document.getElementById('generation-status').classList.add('hidden');
            }
        }

        function setupRating() {
            document.querySelectorAll('#rating-stars span').forEach(s => {
                s.classList.remove('active');
                s.onclick = () => selectRating(parseInt(s.dataset.rating));
            });
            selectedRating = 0;
            document.getElementById('feedback-section').classList.add('hidden');
            document.getElementById('submit-rating-btn').classList.add('hidden');
        }

        function selectRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('#rating-stars span').forEach((s, i) => {
                s.classList.toggle('active', i < rating);
            });

            const opts = rating >= 4 ? `
                <div class="checkbox-item"><input type="checkbox" value="great_pacing"><label>Great pacing</label></div>
                <div class="checkbox-item"><input type="checkbox" value="loved_characters"><label>Loved characters</label></div>
            ` : `
                <div class="checkbox-item"><input type="checkbox" value="too_slow"><label>Too slow</label></div>
                <div class="checkbox-item"><input type="checkbox" value="not_enough_action"><label>Not enough action</label></div>
            `;

            document.getElementById('feedback-options').innerHTML = opts;
            document.getElementById('feedback-section').classList.remove('hidden');
            document.getElementById('submit-rating-btn').classList.remove('hidden');
        }

        async function submitRating() {
            if (!selectedRating) return alert('Select rating');
            const feedback = {};
            document.querySelectorAll('#feedback-options input:checked').forEach(cb => {
                feedback[cb.value] = true;
            });

            await fetch(`${API_URL}/api/dev/rate-story`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({story_id: currentStory.id, rating: selectedRating, feedback})
            });
            log('‚úì Rating submitted!');
            alert('Rating saved!');
        }

        function generateAnother() {
            document.getElementById('story-section').classList.add('hidden');
            document.getElementById('bible-section').classList.remove('hidden');
        }

        async function resetAll() {
            if (confirm('Reset?')) {
                await fetch(`${API_URL}/api/dev/reset`, {method: 'DELETE'});
                location.reload();
            }
        }
    </script>
</body>
</html>
