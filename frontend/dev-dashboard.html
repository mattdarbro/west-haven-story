<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixionMail Dev Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
        }
        .card h2 { color: #667eea; margin-bottom: 20px; font-size: 1.5rem; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-weight: 500; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 1rem;
        }
        textarea { resize: vertical; min-height: 80px; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #dc3545; }
        .debug-panel {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #222; }
        .story-display {
            background: #f9f9f9;
            color: #1a1a1a;
            padding: 40px;
            border-radius: 12px;
            line-height: 1.8;
        }
        .story-title { font-size: 2rem; margin-bottom: 30px; color: #667eea; text-align: center; }
        .story-text { white-space: pre-wrap; }
        .rating-stars { display: flex; gap: 10px; font-size: 2rem; margin: 20px 0; justify-content: center; }
        .rating-stars span { cursor: pointer; opacity: 0.3; }
        .rating-stars span.active { opacity: 1; }
        .hidden { display: none; }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input { width: auto; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìß FixionMail Dev Dashboard</h1>
            <p class="subtitle">Test story generation flow</p>
            <p class="subtitle" style="font-size: 0.9rem; margin-top: 10px;">
                Backend: <span id="backend-url">Loading...</span>
            </p>
        </header>

        <div id="app">
            <div id="onboarding-section">
                <div class="grid">
                    <div class="card">
                        <h2>Step 1: Create Your Story World</h2>
                        <div class="form-group">
                            <label>Genre</label>
                            <select id="genre" onchange="updateGenreUI()">
                                <optgroup label="Recurring Characters">
                                    <option value="comedy_sitcom">üòÇ Comedy / Sitcom</option>
                                    <option value="detective">üîç Detective</option>
                                    <option value="action">üí• Action</option>
                                </optgroup>
                                <optgroup label="Fresh Characters Each Story">
                                    <option value="romance">üíï Romance</option>
                                    <option value="cozy">‚òï Cozy</option>
                                    <option value="fantasy">üßô Fantasy</option>
                                    <option value="western">ü§† Western</option>
                                    <option value="historical">üìú Historical</option>
                                    <option value="scifi">üöÄ Sci-Fi</option>
                                    <option value="strange_fables">üåÄ Strange Fables</option>
                                </optgroup>
                            </select>
                            <small id="genre-hint" style="color: #888; font-size: 12px;"></small>
                        </div>
                        <div class="form-group">
                            <label>Setting / World (1-2 sentences)</label>
                            <textarea id="setting" placeholder="Space station on the edge of known space"></textarea>
                        </div>
                        <div class="form-group" id="character-pool-group">
                            <label>Main Characters <span id="char-pool-note">(add up to 2)</span></label>
                            <div id="character-pool-list"></div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" id="charName" placeholder="Name" style="width: 30%;">
                                <input type="text" id="charDesc" placeholder="Brief description/role" style="width: 50%;">
                                <button type="button" onclick="addCharacter()" style="width: 20%; padding: 8px;">+ Add</button>
                            </div>
                            <small style="color: #888; font-size: 12px;">Main characters that will appear in every story</small>
                        </div>
                        <div class="form-group hidden" id="premise-group">
                            <label>Story Premise (optional)</label>
                            <textarea id="premise" placeholder="A hint for the types of stories you'd like (e.g., 'stories about second chances' or 'underdog heroes')"></textarea>
                            <small style="color: #888; font-size: 12px;">Guides AI character generation</small>
                        </div>
                        <div class="form-group">
                            <label>Intensity: <span id="intensity-label">Moderate</span></label>
                            <input type="range" id="intensity" min="1" max="5" value="3" oninput="updateIntensityLabel()">
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                                <span>Cozy</span><span>Light</span><span>Moderate</span><span>Dramatic</span><span>Intense</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Story Length</label>
                            <select id="storyLength" onchange="updateCostEstimate()">
                                <option value="short">Quick Read (~1500 words)</option>
                                <option value="medium">Standard (~3000 words) - Premium</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Story Structure</label>
                            <select id="beatStructure" onchange="updateStructureInfo()">
                                <option value="classic">Classic Genre Structure (default)</option>
                                <option value="save_the_cat">Save the Cat! (Blake Snyder)</option>
                                <option value="heros_journey">Hero's Journey (Campbell/Vogler)</option>
                                <option value="truby_beats">Truby's Story Anatomy</option>
                            </select>
                            <small id="structure-hint" style="color: #888; font-size: 12px;">Genre-optimized beats tailored for each story type</small>
                        </div>
                        <div class="form-group">
                            <label>Cameo Pool (optional) - Add up to 2</label>
                            <div id="cameo-list"></div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" id="cameoName" placeholder="Name" style="width: 30%;">
                                <input type="text" id="cameoDesc" placeholder="Brief description" style="width: 50%;">
                                <button type="button" onclick="addCameo()" style="width: 20%; padding: 8px;">+ Add</button>
                            </div>
                            <small style="color: #888; font-size: 12px;">People to appear occasionally in stories</small>
                        </div>
                        <div class="form-group">
                            <label>Email (for testing email delivery)</label>
                            <input type="email" id="userEmail" placeholder="your@email.com">
                            <small style="color: #666; font-size: 12px;">Story will be emailed to this address after generation</small>
                        </div>
                        <div class="form-group">
                            <label>TTS Provider</label>
                            <select id="ttsProvider" onchange="updateTtsVoiceOptions(); updateCostEstimate();">
                                <option value="elevenlabs">ElevenLabs (Premium Quality, $99/mo subscription)</option>
                                <option value="openai">OpenAI TTS (Good Quality, Pay-per-use ~10x cheaper)</option>
                            </select>
                            <small id="tts-provider-hint" style="color: #888; font-size: 12px;">Best quality, subscription-based ($99/mo for 500k chars)</small>
                        </div>
                        <div class="form-group">
                            <label>Narrator Voice</label>
                            <select id="voiceId">
                                <optgroup label="ElevenLabs Voices" id="elevenlabs-voices">
                                    <option value="EXAVITQu4vr4xnSDxMaL">Default (Sarah - Female)</option>
                                    <option value="21m00Tcm4TlvDq8ikWAM">Rachel (Female - Calm)</option>
                                    <option value="AZnzlk1XvdvUeBnXmlld">Domi (Female - Strong)</option>
                                    <option value="ErXwobaYiN019PkySvjV">Antoni (Male - Well-rounded)</option>
                                    <option value="VR6AewLTigWG4xSOukaG">Arnold (Male - Crisp)</option>
                                    <option value="pNInz6obpgDQGcFmaJgB">Adam (Male - Deep)</option>
                                    <option value="yoZ06aMxZJJ28mfd3POQ">Sam (Male - Raspy)</option>
                                    <option value="CwhRBWXzGAHq8TQ4Fs17">Roger (Male - Confident)</option>
                                </optgroup>
                                <optgroup label="OpenAI Voices" id="openai-voices" class="hidden">
                                    <option value="alloy">Alloy (Neutral)</option>
                                    <option value="echo">Echo (Male)</option>
                                    <option value="fable">Fable (Expressive)</option>
                                    <option value="onyx">Onyx (Male Deep)</option>
                                    <option value="nova">Nova (Female)</option>
                                    <option value="shimmer">Shimmer (Female Light)</option>
                                </optgroup>
                            </select>
                            <small style="color: #666; font-size: 12px;">Choose a voice for text-to-speech narration</small>
                        </div>
                        <button onclick="createBible()">‚ú® Enhance Bible</button>
                    </div>
                    <div class="card">
                        <h2>üîß Debug Logs</h2>
                        <div id="logs" class="debug-panel">
                            <div class="log-entry">Ready...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bible-section" class="hidden">
                <div class="grid">
                    <div class="card">
                        <h2>Step 2: Generate Story</h2>
                        <div id="bible-preview" class="debug-panel" style="max-height: 300px; margin-bottom: 20px;"></div>

                        <!-- Cost Estimation Panel -->
                        <div id="cost-panel" style="background: #1a2a3a; border: 1px solid #2563eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="color: #60a5fa; margin-bottom: 15px; font-size: 1rem;">üí∞ Estimated Cost</h3>
                            <div id="cost-breakdown" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                <div>
                                    <div style="color: #9ca3af;">Claude API (Prose)</div>
                                    <div id="cost-claude" style="color: #fff; font-weight: 600;">$0.0000</div>
                                </div>
                                <div>
                                    <div style="color: #9ca3af;">Imagen-3 (Cover)</div>
                                    <div id="cost-image" style="color: #fff; font-weight: 600;">$0.0250</div>
                                </div>
                                <div>
                                    <div style="color: #9ca3af;"><span id="audio-provider-label">ElevenLabs</span> (Audio)</div>
                                    <div id="cost-audio" style="color: #fff; font-weight: 600;">$0.0000</div>
                                </div>
                                <div>
                                    <div style="color: #9ca3af;">Per Story Total</div>
                                    <div id="cost-total" style="color: #10b981; font-weight: 700; font-size: 1.1rem;">$0.0000</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #374151;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="color: #9ca3af; font-size: 0.85rem;">Monthly (30 stories/day)</div>
                                    <div id="cost-monthly" style="color: #f59e0b; font-weight: 700; font-size: 1.2rem;">$0.00</div>
                                </div>
                                <div id="tts-subscription-note" style="color: #9ca3af; font-size: 0.75rem; margin-top: 5px;"></div>
                            </div>
                        </div>

                        <button id="generateBtn" onclick="generateStory()">üé¨ Generate Story</button>
                        <button onclick="resetAll()" class="btn-danger" style="margin-left: 10px;">üîÑ Reset</button>
                        <div id="generation-status" class="hidden" style="margin-top: 20px; padding: 15px; background: #1a3a52; border: 1px solid #2563eb; border-radius: 6px; text-align: center;">
                            <div class="spinner" style="margin: 0 auto 10px;"></div>
                            <div id="status-text">Generating story...</div>
                        </div>
                    </div>
                    <div class="card">
                        <h2>üîß Generation Progress</h2>
                        <div id="generation-logs" class="debug-panel">
                            <div class="log-entry">Click "Generate Story" to begin...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="story-section" class="hidden">
                <div class="card">
                    <div id="story-content" class="story-display"></div>
                    <h2 style="margin-top: 30px;">Rate This Story</h2>
                    <div class="rating-stars" id="rating-stars">
                        <span data-rating="1">‚≠ê</span>
                        <span data-rating="2">‚≠ê</span>
                        <span data-rating="3">‚≠ê</span>
                        <span data-rating="4">‚≠ê</span>
                        <span data-rating="5">‚≠ê</span>
                    </div>
                    <div id="feedback-section" class="hidden">
                        <div class="checkbox-group" id="feedback-options"></div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="submitRating()" id="submit-rating-btn" class="hidden">Submit Rating</button>
                        <button onclick="generateAnother()" style="margin-left: 10px;">Generate Another</button>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h2>üîç Debug Info</h2>
                    <div id="debug-info" class="debug-panel"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        document.getElementById('backend-url').textContent = API_URL;

        let currentBible = null;
        let currentStory = null;
        let selectedRating = 0;
        let characterPool = [];
        let cameoPool = [];

        // Genre configuration (mirrors backend)
        const GENRE_CONFIG = {
            comedy_sitcom: { characters: 'user', setting: 'same', world: 'same', hint: 'Recurring cast in familiar settings' },
            detective: { characters: 'user', setting: 'different', world: 'same', hint: 'Same sleuth, new cases' },
            action: { characters: 'user', setting: 'different', world: 'same', hint: 'Same hero, different missions' },
            romance: { characters: 'ai', setting: 'different', world: 'same', hint: 'Fresh love stories each time' },
            cozy: { characters: 'ai', setting: 'different', world: 'same', hint: 'Warm tales with new characters' },
            fantasy: { characters: 'ai', setting: 'different', world: 'same', hint: 'New adventures in your magical world' },
            western: { characters: 'ai', setting: 'different', world: 'same', hint: 'New frontier tales' },
            historical: { characters: 'ai', setting: 'same', world: 'same', hint: 'Different characters, same era' },
            scifi: { characters: 'ai', setting: 'different', world: 'different', hint: 'New worlds and possibilities' },
            strange_fables: { characters: 'ai', setting: 'different', world: 'different', hint: 'Twist endings and morality tales' }
        };

        const INTENSITY_LABELS = ['', 'Cozy', 'Light', 'Moderate', 'Dramatic', 'Intense'];

        const STRUCTURE_HINTS = {
            classic: 'Genre-optimized beats tailored for each story type',
            save_the_cat: 'Hollywood\'s go-to beat sheet - audience engagement and clear emotional beats',
            heros_journey: 'The monomyth - universal pattern of departure, initiation, and return',
            truby_beats: 'Character-driven structure based on weakness, desire, and moral transformation'
        };

        const TTS_PROVIDER_HINTS = {
            elevenlabs: 'Best quality, subscription-based ($99/mo for 500k chars)',
            openai: 'Good quality, pay-per-use ($0.015/1k chars) - ~10x cheaper at scale'
        };

        const TTS_PROVIDER_NAMES = {
            elevenlabs: 'ElevenLabs',
            openai: 'OpenAI TTS'
        };

        function updateStructureInfo() {
            const structure = document.getElementById('beatStructure').value;
            document.getElementById('structure-hint').textContent = STRUCTURE_HINTS[structure] || '';
        }

        function updateTtsVoiceOptions() {
            const provider = document.getElementById('ttsProvider').value;
            const voiceSelect = document.getElementById('voiceId');

            // Update hint
            document.getElementById('tts-provider-hint').textContent = TTS_PROVIDER_HINTS[provider] || '';

            // Show/hide voice groups
            const groups = {
                elevenlabs: document.getElementById('elevenlabs-voices'),
                openai: document.getElementById('openai-voices')
            };

            // Hide all groups
            Object.values(groups).forEach(g => {
                if (g) g.classList.add('hidden');
            });

            // Show selected group
            if (groups[provider]) {
                groups[provider].classList.remove('hidden');
            }

            // Reset to first option in selected group
            const selectedGroup = groups[provider];
            if (selectedGroup) {
                const firstOption = selectedGroup.querySelector('option');
                if (firstOption) {
                    voiceSelect.value = firstOption.value;
                }
            }
        }

        async function updateCostEstimate() {
            const storyLength = document.getElementById('storyLength').value;
            const tier = storyLength === 'short' ? 'free' : 'premium';
            const ttsProvider = document.getElementById('ttsProvider').value;

            // Update provider label in cost panel
            document.getElementById('audio-provider-label').textContent = TTS_PROVIDER_NAMES[ttsProvider] || ttsProvider;

            try {
                const res = await fetch(`${API_URL}/api/dev/estimate-cost?tier=${tier}&story_length=${storyLength}&include_audio=true&include_image=true&tts_provider=${ttsProvider}`);
                const data = await res.json();

                if (data.success) {
                    const est = data.estimate;
                    document.getElementById('cost-claude').textContent = `$${est.claude.total_cost.toFixed(4)}`;
                    document.getElementById('cost-image').textContent = `$${est.image.total_cost.toFixed(4)}`;
                    document.getElementById('cost-audio').textContent = `$${est.audio.total_cost.toFixed(4)}`;
                    document.getElementById('cost-total').textContent = `$${est.total_cost.toFixed(4)}`;
                    document.getElementById('cost-monthly').textContent = `$${est.monthly_cost_30_stories.toFixed(2)}`;

                    // Show subscription note for ElevenLabs
                    const subNote = document.getElementById('tts-subscription-note');
                    if (ttsProvider === 'elevenlabs') {
                        subNote.textContent = '+ $99/mo ElevenLabs Pro subscription';
                    } else {
                        subNote.textContent = 'Pay-per-use, no subscription required';
                    }
                }
            } catch (e) {
                console.error('Cost estimation error:', e);
            }
        }

        function updateGenreUI() {
            const genre = document.getElementById('genre').value;
            const cfg = GENRE_CONFIG[genre] || { characters: 'ai' };

            document.getElementById('genre-hint').textContent = cfg.hint || '';

            if (cfg.characters === 'user') {
                document.getElementById('character-pool-group').classList.remove('hidden');
                document.getElementById('premise-group').classList.add('hidden');
            } else {
                document.getElementById('character-pool-group').classList.add('hidden');
                document.getElementById('premise-group').classList.remove('hidden');
            }
        }

        function addCharacter() {
            const name = document.getElementById('charName').value.trim();
            const desc = document.getElementById('charDesc').value.trim();
            if (!name) return alert('Enter a character name');
            if (characterPool.length >= 2) return alert('Maximum 2 main characters');

            characterPool.push({ name, description: desc });
            renderCharacterPool();
            document.getElementById('charName').value = '';
            document.getElementById('charDesc').value = '';
        }

        function removeCharacter(idx) {
            characterPool.splice(idx, 1);
            renderCharacterPool();
        }

        function renderCharacterPool() {
            const list = document.getElementById('character-pool-list');
            list.innerHTML = characterPool.map((c, i) =>
                `<div style="display:flex;justify-content:space-between;padding:4px 8px;background:#222;border-radius:4px;margin-bottom:4px;">
                    <span><strong>${c.name}</strong>${c.description ? ' - ' + c.description : ''}</span>
                    <span style="cursor:pointer;color:#f66;" onclick="removeCharacter(${i})">√ó</span>
                </div>`
            ).join('');
        }

        function updateIntensityLabel() {
            const val = document.getElementById('intensity').value;
            document.getElementById('intensity-label').textContent = INTENSITY_LABELS[val];
        }

        function addCameo() {
            const name = document.getElementById('cameoName').value.trim();
            const desc = document.getElementById('cameoDesc').value.trim();
            if (!name) return alert('Enter a cameo name');
            if (cameoPool.length >= 2) return alert('Maximum 2 cameos');

            cameoPool.push({ name, description: desc, frequency: 'sometimes' });
            renderCameoList();
            document.getElementById('cameoName').value = '';
            document.getElementById('cameoDesc').value = '';
        }

        function removeCameo(idx) {
            cameoPool.splice(idx, 1);
            renderCameoList();
        }

        function renderCameoList() {
            const list = document.getElementById('cameo-list');
            list.innerHTML = cameoPool.map((c, i) =>
                `<div style="display:flex;justify-content:space-between;padding:4px 8px;background:#222;border-radius:4px;margin-bottom:4px;">
                    <span>${c.name}${c.description ? ' - ' + c.description : ''}</span>
                    <span style="cursor:pointer;color:#f66;" onclick="removeCameo(${i})">√ó</span>
                </div>`
            ).join('');
        }

        function log(msg) {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        async function createBible() {
            log('Creating bible...');
            const data = {
                genre: document.getElementById('genre').value,
                setting: document.getElementById('setting').value,
                character_pool: characterPool.length > 0 ? characterPool : null,
                intensity: parseInt(document.getElementById('intensity').value),
                story_length: document.getElementById('storyLength').value,
                premise: document.getElementById('premise').value || null,
                cameo_pool: cameoPool.length > 0 ? cameoPool : null,
                beat_structure: document.getElementById('beatStructure').value
            };

            if (!data.setting.trim()) return alert('Enter a setting');

            const genre = document.getElementById('genre').value;
            const cfg = GENRE_CONFIG[genre] || { characters: 'ai' };
            if (cfg.characters === 'user' && characterPool.length === 0) {
                return alert('Please add at least 1 main character for this genre');
            }

            // Initialize genre UI
            updateGenreUI();

            try {
                const res = await fetch(`${API_URL}/api/dev/onboarding`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    currentBible = result.bible;

                    // Check for error in fallback bible
                    if (result.bible._error) {
                        log('‚ö†Ô∏è  Using fallback bible due to error');
                        log('Error: ' + result.bible._error);
                        alert('‚ö†Ô∏è  Bible created with fallback data.\n\nError: ' + result.bible._error + '\n\nPlease check Railway environment variables.');
                    } else {
                        log('‚úì Bible enhanced!');
                    }

                    // Handle main_characters (user-defined), protagonist (legacy), or character_template (AI-generated)
                    let charInfo;
                    if (result.bible.main_characters && result.bible.main_characters.length > 0) {
                        const charList = result.bible.main_characters.map(c =>
                            `<strong>${c.name}</strong> (${c.role || 'Main Character'})`
                        ).join(', ');
                        charInfo = `<strong>Main Characters:</strong> ${charList}`;
                    } else if (result.bible.protagonist) {
                        charInfo = `<strong>Protagonist:</strong> ${result.bible.protagonist.name}<br><strong>Trait:</strong> ${result.bible.protagonist.defining_characteristic}`;
                    } else {
                        charInfo = `<strong>Character Style:</strong> ${result.bible.character_template?.archetype || 'Template-based'}<br><strong>Trait:</strong> ${result.bible.character_template?.defining_characteristic || 'Varies'}`;
                    }

                    const genreLabel = result.bible.genre_config?.label || result.bible.genre;
                    const intensityLabel = result.bible.story_settings?.intensity_label || 'Moderate';

                    const errorBanner = result.bible._error
                        ? `<div style="background:#dc3545;color:white;padding:10px;border-radius:6px;margin-bottom:10px;">‚ö†Ô∏è  ${result.bible._error}</div>`
                        : '';

                    const structureLabel = result.bible.beat_structure ? STRUCTURE_HINTS[result.bible.beat_structure] || result.bible.beat_structure : 'Classic Genre';

                    document.getElementById('bible-preview').innerHTML = `
                        ${errorBanner}
                        <strong>Genre:</strong> ${genreLabel} | <strong>Intensity:</strong> ${intensityLabel}<br>
                        <strong>Setting:</strong> ${result.bible.setting.name}<br>
                        <strong>Story Structure:</strong> ${result.bible.beat_structure || 'classic'}<br>
                        ${charInfo}<br>
                        <details><summary>Full JSON</summary><pre>${JSON.stringify(result.bible, null, 2)}</pre></details>
                    `;
                    document.getElementById('onboarding-section').classList.add('hidden');
                    document.getElementById('bible-section').classList.remove('hidden');

                    // Update cost estimate when bible section is shown
                    updateCostEstimate();
                }
            } catch (e) {
                log('‚úó Error: ' + e.message);
                alert('Error: ' + e.message);
            }
        }

        function generationLog(msg) {
            const logs = document.getElementById('generation-logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        let logPollingInterval = null;

        async function pollGenerationLogs() {
            try {
                const res = await fetch(`${API_URL}/api/dev/logs`);
                const data = await res.json();
                if (data.logs && data.logs.length > 0) {
                    const lastLog = data.logs[data.logs.length - 1];
                    generationLog(lastLog.message);
                }
            } catch (e) {
                // Silently fail polling
            }
        }

        async function generateStory() {
            // Disable button to prevent double-clicks
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            // Clear logs
            document.getElementById('generation-logs').innerHTML = '';

            // Show status
            document.getElementById('generation-status').classList.remove('hidden');
            generationLog('Starting story generation...');

            // Start polling logs every 2 seconds
            logPollingInterval = setInterval(pollGenerationLogs, 2000);

            try {
                const email = document.getElementById('userEmail').value;
                const voiceId = document.getElementById('voiceId').value;
                const ttsProvider = document.getElementById('ttsProvider').value;

                generationLog('Sending request to server...');
                generationLog(`TTS Provider: ${TTS_PROVIDER_NAMES[ttsProvider]}`);

                const res = await fetch(`${API_URL}/api/dev/generate-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bible: currentBible,
                        email: email || null,
                        voice_id: voiceId,
                        tts_provider: ttsProvider,
                        tts_voice: voiceId
                    })
                });

                generationLog('Server responded, processing...');
                const data = await res.json();

                // Stop polling
                clearInterval(logPollingInterval);
                logPollingInterval = null;

                if (data.success) {
                    currentStory = data.story;
                    generationLog(`‚úì Story generated! ${data.story.word_count} words in ${data.debug.generation_time.toFixed(1)}s`);

                    if (data.email_sent) {
                        generationLog(`‚úì Email sent successfully!`);
                    }

                    document.getElementById('story-content').innerHTML = `
                        <div class="story-title">${data.story.title}</div>
                        <div class="story-text">${data.story.narrative}</div>
                    `;
                    document.getElementById('debug-info').innerHTML = `
                        <strong>Words:</strong> ${data.story.word_count}<br>
                        <strong>Time:</strong> ${data.debug.generation_time.toFixed(1)}s<br>
                        <strong>Plot:</strong> ${data.debug.plot_type}<br>
                        <strong>TTS Provider:</strong> ${TTS_PROVIDER_NAMES[data.story.tts_provider] || data.story.tts_provider}<br>
                        <strong>Email Sent:</strong> ${data.email_sent ? 'Yes ‚úì' : 'No'}<br>
                        <details><summary>Beat Plan</summary><pre>${JSON.stringify(data.debug.beat_plan, null, 2)}</pre></details>
                    `;

                    // Hide status and move to story section
                    document.getElementById('generation-status').classList.add('hidden');
                    document.getElementById('bible-section').classList.add('hidden');
                    document.getElementById('story-section').classList.remove('hidden');
                    setupRating();
                } else {
                    generationLog('‚úó Error: ' + (data.error || 'Unknown error'));
                    alert('Generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                // Stop polling
                if (logPollingInterval) {
                    clearInterval(logPollingInterval);
                    logPollingInterval = null;
                }

                generationLog('‚úó Error: ' + e.message);
                alert('Error: ' + e.message);
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'üé¨ Generate Story';
                document.getElementById('generation-status').classList.add('hidden');
            }
        }

        function setupRating() {
            document.querySelectorAll('#rating-stars span').forEach(s => {
                s.classList.remove('active');
                s.onclick = () => selectRating(parseInt(s.dataset.rating));
            });
            selectedRating = 0;
            document.getElementById('feedback-section').classList.add('hidden');
            document.getElementById('submit-rating-btn').classList.add('hidden');
        }

        function selectRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('#rating-stars span').forEach((s, i) => {
                s.classList.toggle('active', i < rating);
            });

            const opts = rating >= 4 ? `
                <div class="checkbox-item"><input type="checkbox" value="great_pacing"><label>Great pacing</label></div>
                <div class="checkbox-item"><input type="checkbox" value="loved_characters"><label>Loved characters</label></div>
            ` : `
                <div class="checkbox-item"><input type="checkbox" value="too_slow"><label>Too slow</label></div>
                <div class="checkbox-item"><input type="checkbox" value="not_enough_action"><label>Not enough action</label></div>
            `;

            document.getElementById('feedback-options').innerHTML = opts;
            document.getElementById('feedback-section').classList.remove('hidden');
            document.getElementById('submit-rating-btn').classList.remove('hidden');
        }

        async function submitRating() {
            if (!selectedRating) return alert('Select rating');
            const feedback = {};
            document.querySelectorAll('#feedback-options input:checked').forEach(cb => {
                feedback[cb.value] = true;
            });

            await fetch(`${API_URL}/api/dev/rate-story`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({story_id: currentStory.id, rating: selectedRating, feedback})
            });
            log('‚úì Rating submitted!');
            alert('Rating saved!');
        }

        function generateAnother() {
            document.getElementById('story-section').classList.add('hidden');
            document.getElementById('bible-section').classList.remove('hidden');
        }

        async function resetAll() {
            if (confirm('Reset?')) {
                await fetch(`${API_URL}/api/dev/reset`, {method: 'DELETE'});
                location.reload();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateGenreUI();
            updateIntensityLabel();
            updateTtsVoiceOptions();
        });
    </script>
</body>
</html>
